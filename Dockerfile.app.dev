# Simple Next.js App Dockerfile
FROM node:22-alpine

WORKDIR /app

# Accept build arguments
ARG GEMINI_API_KEY
ARG OPENAI_API_KEY
ARG GENERATIVE_FAST_LLM_MODEL
ARG GENERATIVE_THINK_LLM_MODEL
ARG WORKER_URL
ARG NEXTAUTH_SECRET
ARG NEXTAUTH_URL
ARG DATABASE_URL

# Install pnpm
RUN npm install -g pnpm

# Copy package files
COPY package.json pnpm-lock.yaml ./
COPY prisma ./prisma/

# Install dependencies
RUN pnpm install

# Copy source code
COPY . .

# Set environment variables needed for build
ENV GEMINI_API_KEY=$GEMINI_API_KEY
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV GENERATIVE_FAST_LLM_MODEL=$GENERATIVE_FAST_LLM_MODEL
ENV GENERATIVE_THINK_LLM_MODEL=$GENERATIVE_THINK_LLM_MODEL
ENV WORKER_URL=$WORKER_URL
ENV NEXTAUTH_SECRET=$NEXTAUTH_SECRET
ENV NEXTAUTH_URL=$NEXTAUTH_URL
ENV DATABASE_URL=$DATABASE_URL

# Generate Prisma client and build
RUN pnpm db:gen && pnpm build

# Expose port and start
EXPOSE 3000
CMD ["pnpm", "dev"]
